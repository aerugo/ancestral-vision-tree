<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Evaluation Suite - Ancestral Vision Tree</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2f 100%);
            color: #e0e0e0;
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            min-height: 100vh;
        }
        h1 {
            color: #7fffd4;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(127, 255, 212, 0.5);
            font-size: 2em;
        }
        .subtitle {
            color: #888;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            background: linear-gradient(135deg, rgba(127, 255, 212, 0.2), rgba(80, 200, 180, 0.1));
            border: 1px solid rgba(127, 255, 212, 0.4);
            color: #7fffd4;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        button:hover {
            background: linear-gradient(135deg, rgba(127, 255, 212, 0.3), rgba(80, 200, 180, 0.2));
            box-shadow: 0 0 20px rgba(127, 255, 212, 0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 1200px) {
            .test-container { grid-template-columns: 1fr; }
        }
        .test-panel {
            background: rgba(20, 30, 40, 0.8);
            border: 1px solid rgba(80, 200, 180, 0.3);
            border-radius: 12px;
            padding: 20px;
        }
        .test-panel h3 {
            color: #7fffd4;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-panel canvas {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .metric {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
        }
        .metric-label {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .metric-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #7fffd4;
        }
        .metric-bar {
            height: 4px;
            background: rgba(127, 255, 212, 0.2);
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        .metric-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #7fffd4, #50c8b4);
            transition: width 0.3s;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-pass {
            background: rgba(0, 200, 100, 0.2);
            color: #00ff88;
            border: 1px solid rgba(0, 200, 100, 0.3);
        }
        .status-fail {
            background: rgba(255, 80, 80, 0.2);
            color: #ff5050;
            border: 1px solid rgba(255, 80, 80, 0.3);
        }
        .status-running {
            background: rgba(255, 200, 0, 0.2);
            color: #ffcc00;
            border: 1px solid rgba(255, 200, 0, 0.3);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .hue-histogram {
            display: flex;
            height: 40px;
            gap: 2px;
            margin-top: 10px;
        }
        .hue-bar {
            flex: 1;
            border-radius: 2px 2px 0 0;
            transition: height 0.3s;
        }
        #log-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .log-time { color: #666; }
        .log-info { color: #7fffd4; }
        .log-success { color: #00ff88; }
        .log-error { color: #ff5050; }
        .log-warn { color: #ffcc00; }

        .summary-panel {
            background: rgba(20, 30, 40, 0.9);
            border: 2px solid rgba(127, 255, 212, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        @media (max-width: 800px) {
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
        }
        .summary-stat {
            text-align: center;
        }
        .summary-stat .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #7fffd4;
        }
        .summary-stat .label {
            font-size: 0.9em;
            color: #888;
        }
        .export-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        .export-section textarea {
            width: 100%;
            height: 150px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(127, 255, 212, 0.3);
            color: #e0e0e0;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            border-radius: 4px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <h1>Visual Evaluation Suite</h1>
    <p class="subtitle">Programmatic visual testing for AI-assisted development</p>

    <div class="controls">
        <button id="run-all-btn">Run All Tests</button>
        <button id="export-report-btn">Export JSON Report</button>
        <button id="capture-screenshots-btn">Capture Screenshots</button>
        <button id="clear-log-btn">Clear Log</button>
    </div>

    <div class="summary-panel">
        <div class="summary-grid">
            <div class="summary-stat">
                <div class="value" id="total-tests">0</div>
                <div class="label">Total Tests</div>
            </div>
            <div class="summary-stat">
                <div class="value" id="passed-tests">0</div>
                <div class="label">Passed</div>
            </div>
            <div class="summary-stat">
                <div class="value" id="failed-tests">0</div>
                <div class="label">Failed</div>
            </div>
            <div class="summary-stat">
                <div class="value" id="avg-bloom">-</div>
                <div class="label">Avg Bloom %</div>
            </div>
        </div>
    </div>

    <div class="test-container" id="test-container"></div>

    <div id="log-container"></div>

    <div class="export-section">
        <h4 style="color: #7fffd4; margin-bottom: 10px;">JSON Report Output</h4>
        <textarea id="json-output" readonly placeholder="Run tests to generate report..."></textarea>
    </div>

    <script type="module">
        import init, { AncestralVisionTree, VisualAnalyzer } from '../pkg/ancestral_vision_tree.js';

        // Test configurations with visual criteria
        const TEST_CONFIGS = [
            {
                id: 'simple-tree',
                name: 'Simple Tree (3 nodes)',
                description: 'Basic tree structure with minimal branching',
                yaml: `
family:
  name: "Simple Test"
  root: "root"
people:
  - id: "root"
    name: "Root Person"
    biography: "The founder of the lineage."
    children: ["child1", "child2"]
  - id: "child1"
    name: "Child One"
    biography: "First child."
  - id: "child2"
    name: "Child Two"
    biography: "Second child."
`,
                criteria: {
                    minBrightness: 0.05,
                    minBloom: 0.01,
                    minSaturation: 0.1,
                    maxDarkPixels: 0.95
                }
            },
            {
                id: 'biography-test',
                name: 'Biography Influence',
                description: 'Tests that longer biographies create brighter branches',
                yaml: `
family:
  name: "Biography Test"
  root: "root"
people:
  - id: "root"
    name: "Root"
    biography: |
      This is a very long biography that should result in a prominent, glowing
      branch. The person lived a full life with many accomplishments, travels,
      and relationships that made them who they were. Their story spans decades
      and continents, touching countless lives along the way.

      Chapter after chapter of their life unfolds like a novel, each phase
      bringing new challenges and triumphs. They were known for their wisdom,
      their kindness, and their unwavering dedication to family.
    children: ["short", "long"]
  - id: "short"
    name: "Short Bio"
    biography: "Brief."
  - id: "long"
    name: "Long Bio"
    biography: |
      Another person with a rich and detailed life story. Their biography
      captures the essence of who they were - their dreams, struggles,
      victories, and the legacy they left behind. Every word adds to
      the luminescence of their branch.
`,
                criteria: {
                    minBrightness: 0.06,
                    minBloom: 0.02,
                    minSaturation: 0.15,
                    maxDarkPixels: 0.92
                }
            },
            {
                id: 'deep-tree',
                name: 'Deep Tree (4 generations)',
                description: 'Tests rendering of multi-generational tree',
                yaml: `
family:
  name: "Deep Tree"
  root: "gen1"
people:
  - id: "gen1"
    name: "Generation 1"
    biography: "The ancient ancestor."
    children: ["gen2a", "gen2b"]
  - id: "gen2a"
    name: "Gen 2A"
    biography: "First branch of second generation."
    children: ["gen3a", "gen3b"]
  - id: "gen2b"
    name: "Gen 2B"
    biography: "Second branch."
    children: ["gen3c"]
  - id: "gen3a"
    name: "Gen 3A"
    biography: "Third generation leaf."
  - id: "gen3b"
    name: "Gen 3B"
    biography: "Another third generation."
    children: ["gen4"]
  - id: "gen3c"
    name: "Gen 3C"
    biography: "Yet another leaf."
  - id: "gen4"
    name: "Gen 4"
    biography: "The newest generation."
`,
                criteria: {
                    minBrightness: 0.05,
                    minBloom: 0.01,
                    minSaturation: 0.1,
                    maxDarkPixels: 0.94
                }
            },
            {
                id: 'full-family',
                name: 'Full Family (Large Tree)',
                description: 'Tests rendering with many nodes',
                yaml: `
family:
  name: "Oakhart Legacy"
  root: "patriarch"
people:
  - id: "patriarch"
    name: "Elder Oakhart"
    biography: |
      The founder of the Oakhart line, known throughout the land for wisdom
      and compassion. Built the family home that would shelter generations.
    children: ["alice", "bob", "carol"]
  - id: "alice"
    name: "Alice Oakhart"
    biography: "The eldest, keeper of traditions."
    children: ["dave", "eve"]
  - id: "bob"
    name: "Bob Oakhart"
    biography: "The adventurer who mapped distant lands."
    children: ["frank"]
  - id: "carol"
    name: "Carol Oakhart"
    biography: "The scholar who wrote the family history."
  - id: "dave"
    name: "Dave"
    biography: "Craftsman."
  - id: "eve"
    name: "Eve"
    biography: "Healer."
    children: ["grace", "henry"]
  - id: "frank"
    name: "Frank"
    biography: "Explorer."
  - id: "grace"
    name: "Grace"
    biography: "Artist."
  - id: "henry"
    name: "Henry"
    biography: "Inventor."
`,
                criteria: {
                    minBrightness: 0.05,
                    minBloom: 0.01,
                    minSaturation: 0.1,
                    maxDarkPixels: 0.93
                }
            }
        ];

        // HUE color names for histogram
        const HUE_COLORS = [
            '#ff0000', '#ff8000', '#ffff00', '#80ff00',
            '#00ff00', '#00ff80', '#00ffff', '#0080ff',
            '#0000ff', '#8000ff', '#ff00ff', '#ff0080'
        ];

        let testResults = {};
        let engines = {};

        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const time = new Date().toISOString().substr(11, 12);
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function createTestPanel(config) {
            const panel = document.createElement('div');
            panel.className = 'test-panel';
            panel.id = `panel-${config.id}`;
            panel.innerHTML = `
                <h3>
                    ${config.name}
                    <span class="status-badge status-running" id="status-${config.id}">Pending</span>
                </h3>
                <p style="color: #888; font-size: 0.85em; margin-bottom: 15px;">${config.description}</p>
                <canvas id="canvas-${config.id}"></canvas>
                <div class="metrics-grid" id="metrics-${config.id}">
                    <div class="metric">
                        <div class="metric-label">Brightness</div>
                        <div class="metric-value" id="brightness-${config.id}">-</div>
                        <div class="metric-bar"><div class="metric-bar-fill" id="brightness-bar-${config.id}" style="width: 0%"></div></div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Bloom</div>
                        <div class="metric-value" id="bloom-${config.id}">-</div>
                        <div class="metric-bar"><div class="metric-bar-fill" id="bloom-bar-${config.id}" style="width: 0%"></div></div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Saturation</div>
                        <div class="metric-value" id="saturation-${config.id}">-</div>
                        <div class="metric-bar"><div class="metric-bar-fill" id="saturation-bar-${config.id}" style="width: 0%"></div></div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Contrast</div>
                        <div class="metric-value" id="contrast-${config.id}">-</div>
                        <div class="metric-bar"><div class="metric-bar-fill" id="contrast-bar-${config.id}" style="width: 0%"></div></div>
                    </div>
                </div>
                <div class="hue-histogram" id="hue-${config.id}">
                    ${HUE_COLORS.map((color, i) => `<div class="hue-bar" style="background: ${color}; height: 10%"></div>`).join('')}
                </div>
            `;
            return panel;
        }

        function updateMetrics(configId, metrics) {
            document.getElementById(`brightness-${configId}`).textContent = (metrics.avgBrightness * 100).toFixed(1) + '%';
            document.getElementById(`brightness-bar-${configId}`).style.width = (metrics.avgBrightness * 100) + '%';

            document.getElementById(`bloom-${configId}`).textContent = (metrics.bloomCoverage * 100).toFixed(1) + '%';
            document.getElementById(`bloom-bar-${configId}`).style.width = (metrics.bloomCoverage * 100) + '%';

            document.getElementById(`saturation-${configId}`).textContent = (metrics.avgSaturation * 100).toFixed(1) + '%';
            document.getElementById(`saturation-bar-${configId}`).style.width = (metrics.avgSaturation * 100) + '%';

            const contrastNorm = Math.min(metrics.contrastRatio / 20, 1);
            document.getElementById(`contrast-${configId}`).textContent = metrics.contrastRatio.toFixed(1) + 'x';
            document.getElementById(`contrast-bar-${configId}`).style.width = (contrastNorm * 100) + '%';

            // Update hue histogram
            const hueContainer = document.getElementById(`hue-${configId}`);
            const bars = hueContainer.querySelectorAll('.hue-bar');
            const maxHue = Math.max(...metrics.hueHistogram);
            bars.forEach((bar, i) => {
                const height = maxHue > 0 ? (metrics.hueHistogram[i] / maxHue) * 100 : 10;
                bar.style.height = Math.max(height, 5) + '%';
            });
        }

        function checkCriteria(metrics, criteria) {
            const failures = [];
            if (metrics.avgBrightness < criteria.minBrightness) {
                failures.push(`Brightness ${(metrics.avgBrightness*100).toFixed(1)}% < ${(criteria.minBrightness*100).toFixed(1)}%`);
            }
            if (metrics.bloomCoverage < criteria.minBloom) {
                failures.push(`Bloom ${(metrics.bloomCoverage*100).toFixed(1)}% < ${(criteria.minBloom*100).toFixed(1)}%`);
            }
            if (metrics.avgSaturation < criteria.minSaturation) {
                failures.push(`Saturation ${(metrics.avgSaturation*100).toFixed(1)}% < ${(criteria.minSaturation*100).toFixed(1)}%`);
            }
            if (metrics.darkPixels > criteria.maxDarkPixels) {
                failures.push(`Dark pixels ${(metrics.darkPixels*100).toFixed(1)}% > ${(criteria.maxDarkPixels*100).toFixed(1)}%`);
            }
            return failures;
        }

        function setStatus(configId, passed, failures = []) {
            const badge = document.getElementById(`status-${configId}`);
            badge.className = `status-badge status-${passed ? 'pass' : 'fail'}`;
            badge.textContent = passed ? 'PASS' : 'FAIL';
            if (!passed && failures.length > 0) {
                badge.title = failures.join('\n');
            }
        }

        function updateSummary() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r.passed).length;
            const failed = total - passed;
            const avgBloom = Object.values(testResults).reduce((sum, r) => sum + (r.metrics?.bloomCoverage || 0), 0) / Math.max(total, 1);

            document.getElementById('total-tests').textContent = total;
            document.getElementById('passed-tests').textContent = passed;
            document.getElementById('failed-tests').textContent = failed;
            document.getElementById('avg-bloom').textContent = (avgBloom * 100).toFixed(1) + '%';
        }

        async function runTest(config) {
            const canvas = document.getElementById(`canvas-${config.id}`);
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.clientWidth * dpr;
            canvas.height = canvas.clientHeight * dpr;

            try {
                log(`Starting test: ${config.name}`, 'info');
                const engine = new AncestralVisionTree(canvas);
                engine.load_family(config.yaml);
                engines[config.id] = engine;

                // Render several frames to stabilize
                const frameCount = 90;
                for (let i = 0; i < frameCount; i++) {
                    engine.render(1/60);
                    await new Promise(r => requestAnimationFrame(r));
                }

                // Capture pixels for analysis
                const gl = canvas.getContext('webgl2');
                const width = canvas.width;
                const height = canvas.height;
                const pixels = new Uint8Array(width * height * 4);
                gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);

                // Analyze using Rust module
                const metricsJson = VisualAnalyzer.analyze(pixels, width, height);
                const metrics = JSON.parse(metricsJson);

                // Update UI
                updateMetrics(config.id, metrics);

                // Check criteria
                const failures = checkCriteria(metrics, config.criteria);
                const passed = failures.length === 0;

                setStatus(config.id, passed, failures);

                testResults[config.id] = {
                    name: config.name,
                    passed,
                    failures,
                    metrics,
                    timestamp: new Date().toISOString()
                };

                if (passed) {
                    log(`${config.name}: PASSED`, 'success');
                } else {
                    log(`${config.name}: FAILED - ${failures.join(', ')}`, 'error');
                }

                updateSummary();
                return passed;
            } catch (error) {
                log(`${config.name}: ERROR - ${error.message}`, 'error');
                setStatus(config.id, false, [error.message]);
                testResults[config.id] = {
                    name: config.name,
                    passed: false,
                    failures: [error.message],
                    metrics: null,
                    timestamp: new Date().toISOString()
                };
                updateSummary();
                return false;
            }
        }

        async function runAllTests() {
            document.getElementById('run-all-btn').disabled = true;
            testResults = {};

            log('=== Starting Visual Evaluation Suite ===', 'info');

            for (const config of TEST_CONFIGS) {
                await runTest(config);
            }

            const passed = Object.values(testResults).filter(r => r.passed).length;
            const total = TEST_CONFIGS.length;

            if (passed === total) {
                log(`=== All ${total} tests PASSED ===`, 'success');
            } else {
                log(`=== ${passed}/${total} tests passed, ${total - passed} FAILED ===`, 'warn');
            }

            document.getElementById('run-all-btn').disabled = false;
            exportReport();
        }

        function exportReport() {
            const report = {
                suite: 'Ancestral Vision Tree - Visual Evaluation',
                timestamp: new Date().toISOString(),
                summary: {
                    total: Object.keys(testResults).length,
                    passed: Object.values(testResults).filter(r => r.passed).length,
                    failed: Object.values(testResults).filter(r => !r.passed).length
                },
                tests: testResults
            };

            const json = JSON.stringify(report, null, 2);
            document.getElementById('json-output').value = json;
            return json;
        }

        async function captureScreenshots() {
            log('Capturing screenshots...', 'info');

            for (const config of TEST_CONFIGS) {
                const canvas = document.getElementById(`canvas-${config.id}`);
                if (canvas) {
                    try {
                        const dataUrl = canvas.toDataURL('image/png');
                        const link = document.createElement('a');
                        link.download = `screenshot-${config.id}-${Date.now()}.png`;
                        link.href = dataUrl;
                        link.click();
                        log(`Screenshot saved: ${link.download}`, 'success');
                    } catch (e) {
                        log(`Failed to capture ${config.id}: ${e.message}`, 'error');
                    }
                }
            }
        }

        async function initialize() {
            log('Initializing WASM module...', 'info');
            await init();
            log('WASM initialized successfully', 'success');

            // Create test panels
            const container = document.getElementById('test-container');
            for (const config of TEST_CONFIGS) {
                container.appendChild(createTestPanel(config));
            }

            // Set up button handlers
            document.getElementById('run-all-btn').addEventListener('click', runAllTests);
            document.getElementById('export-report-btn').addEventListener('click', () => {
                const json = exportReport();
                navigator.clipboard.writeText(json).then(() => {
                    log('Report copied to clipboard', 'success');
                });
            });
            document.getElementById('capture-screenshots-btn').addEventListener('click', captureScreenshots);
            document.getElementById('clear-log-btn').addEventListener('click', () => {
                document.getElementById('log-container').innerHTML = '';
            });

            log('Visual Evaluation Suite ready. Click "Run All Tests" to begin.', 'info');
        }

        initialize().catch(err => {
            log(`Initialization failed: ${err.message}`, 'error');
            console.error(err);
        });
    </script>
</body>
</html>
