<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Test - Ancestral Vision Tree</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a0f;
            color: #e0e0e0;
            font-family: system-ui, sans-serif;
            padding: 20px;
        }
        h1 {
            color: #7fffd4;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(127, 255, 212, 0.5);
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .test-case {
            background: rgba(20, 30, 40, 0.8);
            border: 1px solid rgba(80, 200, 180, 0.3);
            border-radius: 12px;
            padding: 15px;
        }
        .test-case h3 {
            color: #7fffd4;
            margin-bottom: 10px;
        }
        .test-case canvas {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
        }
        .test-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #888;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .status.pass { background: rgba(0, 200, 100, 0.3); color: #0f8; }
        .status.fail { background: rgba(200, 0, 50, 0.3); color: #f44; }
        .status.running { background: rgba(200, 200, 0, 0.3); color: #ff0; }

        #log {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        #log .error { color: #f44; }
        #log .success { color: #0f8; }
        #log .info { color: #7fffd4; }
    </style>
</head>
<body>
    <h1>Visual Test Suite - Ancestral Vision Tree</h1>

    <div class="test-grid">
        <div class="test-case" id="test-simple">
            <h3>Test 1: Simple Tree (3 people)</h3>
            <canvas id="canvas-simple"></canvas>
            <div class="test-info">
                <span class="status running" id="status-simple">Running...</span>
                Tests basic rendering with minimal family tree
            </div>
        </div>

        <div class="test-case" id="test-complex">
            <h3>Test 2: Complex Tree (Many generations)</h3>
            <canvas id="canvas-complex"></canvas>
            <div class="test-info">
                <span class="status running" id="status-complex">Running...</span>
                Tests deep tree with multiple branches
            </div>
        </div>

        <div class="test-case" id="test-biography">
            <h3>Test 3: Biography Influence</h3>
            <canvas id="canvas-biography"></canvas>
            <div class="test-info">
                <span class="status running" id="status-biography">Running...</span>
                Tests that longer biographies create more prominent branches
            </div>
        </div>
    </div>

    <div id="log"></div>

    <script type="module">
        import init, { AncestralVisionTree } from '../pkg/ancestral_vision_tree.js';

        const SIMPLE_YAML = `
family:
  name: "Simple Test"
  root: "root"
people:
  - id: "root"
    name: "Root Person"
    biography: "The founder."
    children:
      - "child1"
      - "child2"
  - id: "child1"
    name: "Child One"
    biography: "First child."
  - id: "child2"
    name: "Child Two"
    biography: "Second child."
`;

        const COMPLEX_YAML = `
family:
  name: "Complex Test"
  root: "gen1"
people:
  - id: "gen1"
    name: "Generation 1"
    biography: "The ancient ancestor who started it all."
    children: ["gen2a", "gen2b"]
  - id: "gen2a"
    name: "Gen 2A"
    biography: "First branch."
    children: ["gen3a", "gen3b"]
  - id: "gen2b"
    name: "Gen 2B"
    biography: "Second branch."
    children: ["gen3c"]
  - id: "gen3a"
    name: "Gen 3A"
    biography: "Leaf"
  - id: "gen3b"
    name: "Gen 3B"
    biography: "Leaf"
    children: ["gen4"]
  - id: "gen3c"
    name: "Gen 3C"
    biography: "Leaf"
  - id: "gen4"
    name: "Gen 4"
    biography: "Newest"
`;

        const BIOGRAPHY_YAML = `
family:
  name: "Biography Test"
  root: "root"
people:
  - id: "root"
    name: "Root"
    biography: |
      This is a very long biography that should result in a prominent, glowing
      branch. The person lived a full life with many accomplishments, travels,
      and relationships that made them who they were. Their story spans decades
      and continents, touching countless lives along the way.

      Chapter after chapter of their life unfolds like a novel, each phase
      bringing new challenges and triumphs. They were known for their wisdom,
      their kindness, and their unwavering dedication to family and community.
    children: ["short", "long"]
  - id: "short"
    name: "Short Bio Person"
    biography: "Brief."
  - id: "long"
    name: "Long Bio Person"
    biography: |
      Another person with a rich and detailed life story. Their biography
      captures the essence of who they were - their dreams, their struggles,
      their victories, and the legacy they left behind. Every word adds to
      the luminescence of their branch in the ancestral tree.
`;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${new Date().toISOString().substr(11, 8)}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStatus(testId, passed) {
            const el = document.getElementById(`status-${testId}`);
            el.className = `status ${passed ? 'pass' : 'fail'}`;
            el.textContent = passed ? 'PASS' : 'FAIL';
        }

        async function runTest(canvasId, yaml, testId) {
            const canvas = document.getElementById(canvasId);
            const dpr = window.devicePixelRatio || 1;
            canvas.width = canvas.clientWidth * dpr;
            canvas.height = canvas.clientHeight * dpr;

            try {
                log(`Starting test: ${testId}`, 'info');
                const engine = new AncestralVisionTree(canvas);
                engine.load_family(yaml);

                // Render a few frames
                let frameCount = 0;
                const maxFrames = 60;

                function animate() {
                    engine.render(1/60);
                    frameCount++;

                    if (frameCount < maxFrames) {
                        requestAnimationFrame(animate);
                    } else {
                        log(`Test ${testId}: Rendered ${frameCount} frames`, 'success');
                        setStatus(testId, true);
                    }
                }

                animate();
                return true;
            } catch (error) {
                log(`Test ${testId} failed: ${error.message}`, 'error');
                setStatus(testId, false);
                return false;
            }
        }

        async function runAllTests() {
            log('Initializing WASM...', 'info');
            await init();
            log('WASM initialized', 'success');

            await runTest('canvas-simple', SIMPLE_YAML, 'simple');
            await runTest('canvas-complex', COMPLEX_YAML, 'complex');
            await runTest('canvas-biography', BIOGRAPHY_YAML, 'biography');

            log('All tests completed', 'success');
        }

        runAllTests().catch(err => {
            log(`Fatal error: ${err.message}`, 'error');
            console.error(err);
        });
    </script>
</body>
</html>
